---
title: "Introduction to corncob"
author: "Bryan D Martin"
output: pdf_document
vignette: >
  %\VignetteIndexEntry{Introduction to corncob}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

This tutorial is intended for STAMPS 2019.

When studying dysbiosis, the focus is often on identifying differentially abundant taxa. However, microbial imbalance can also affect the stability of taxa. Here, we introduce \texttt{corncob}, an individual taxon regression model that uses abundance tables and sample data. \texttt{corncob} is able to model differential abundance and differential variability. \texttt{corncob} is appropriate for both rare and common taxa, excessive zeros, overdispersion, and inconsistent sequencing depths.

To begin, we load an example data set as a \texttt{phyloseq} object.

```{r, message = FALSE}
library(corncob)
library(phyloseq)
data(soil_phylo)
```

If you are unfamiliar with \texttt{phyloseq}, we can view a description of the data using:

```{r}
soil_phylo
```

We now see that we have an OTU abundance table with 7770 OTUs and 119 samples. We can extract using \texttt{otu\_table()}. Let's examine a small subset of our data in more detail.
```{r}
otu_table(soil_phylo)[1:5, 1:5]
```

We can also see that we have 5 sample variables. We can extract this using \texttt{sample\_data()}. Let's again examine a small subset in more detail.
```{r}
sample_data(soil_phylo)[1:5, ]
```


# Fitting a Model

Now, let's set up our model. We will demonstrate with OTU149.

First, let's subset our data to only include samples with the \texttt{DayAmdmt} covariate equal to 11 or 21.

```{r}
soil <- phyloseq::subset_samples(soil_phylo, DayAmdmt %in% c(11,21))
```

Next, let's fit our model. For now, we will not include any covariates, so we use \texttt{~ 1} as our model formula responses.

```{r}
mod <- bbdml(formula = OTU149 ~ 1,
             phi.formula = ~ 1,
             data = soil)
```

# Interpreting a Model

First, let's plot our model on the absolute abundance scale. To do this, we simply type:

```{r}
plot(mod)
```

The points represent the absolute abundances. The bars represent the 95\% confidence intervals for the absolute abundance by sample. 

Now let's look at the same model, but on the relative abundance scale. To do this, we add the option \texttt{RA = TRUE} to our plotting code.

```{r}
plot(mod, RA = TRUE)
```

Finally, let's color the plot by the \texttt{DayAmdmt} covariate. To do this, we add the option \texttt{group = "DayAmdmt"} to our plotting code. 

```{r}
plot(mod, RA = TRUE, group = "DayAmdmt")
```

Notice that this plot also reorders our samples so that groups appear together so that they are easier to compare.


We can observe on this plot that it might be of interest to distinguish between the two groups with covariates. The average empirical relative abundance for the samples with \texttt{DayAmdmt = 21} tends to be lower and less variable than the samples with \texttt{DayAmdmt = 11}.

# Adding covariates

Let's try modeling the expected relative abundance and the variability of the absolute abundance with \texttt{DayAmdmt} as a covariate. We do this by modifying \texttt{formula} and \texttt{phi.formula} as:

```{r}
mod_cov <- bbdml(formula = OTU149 ~ DayAmdmt,
             phi.formula = ~ DayAmdmt,
             data = soil)
```

Let's also plot this data on both the absolute abudance relative abundance scale.

```{r}
plot(mod_cov, group = "DayAmdmt")
```

```{r}
plot(mod_cov, group = "DayAmdmt", RA = TRUE)
```

Visually, the model with covariates seems to provide a much better fit to the data, but how can we compare the two models statistically?

# Model Selection

Let's use a likelihood ratio test to select our final model for this taxon. We want to test the null hypothesis that the model with covariates does not have a statistically significantly different log-likelihood than the model without covariates. To do this test, we use:

```{r}
lrtest(mod, mod_cov)
```
We obtain a p-value much smaller than a cut-off of 0.05. Therefore we conclude that there is a statistically significant difference in the likelihood of the two models. Thus, we probably want to use the model with covariates for this taxon.

# Parameter Interpretation

Now that we have chosen our model, let's interpret our model output. To see a summary of the model, type:

```{r}
summary(mod_cov)
```
This output will look familiar if you have done regression analysis in R in the past. Covariates associated with the overdispersion of the absolute abundances are preceded by \texttt{phi.}. 

From this model summary, we can see that the \texttt{DayAmdmt21} coefficient is negative and statistically significant. This suggests that this taxon is differentially-abundant across \texttt{DayAmdmt}, and that samples with \texttt{DayAmdmt = 21} are expected to have a lower relative abundance. This matches what we would expect given the plot of the data.

We can also see that the \texttt{phi.DayAmdmt21} coefficient is negative and statistically significant. This suggests that this taxon is differentially-variable across \texttt{DayAmdmt}, and that samples with \texttt{DayAmdmt = 21} are expected to have a lower variability. This also matches what we would expect given the plot of the data.

# Analysis for Multiple Taxa

What if we want to test all the taxa in our data to see if they are differentially-abundant or differentially-variable? We use the \texttt{differentialTest} function. It will perform the above tests on all taxa, and it will control the false discovery rate to account for multiple comparisons.

This will take a few seconds to complete, so for the sake of time in this tutorial, let's use the \texttt{prune\_taxa} function from the \texttt{phyloseq} package to select only the first 100 OTUs. We can then examine the data to make sure it did what we wanted.

```{r}
subsoil <- phyloseq::prune_taxa(x = soil, taxa = rownames(otu_table(soil))[1:100])
subsoil
```

Next, we use the \texttt{differentialTest} command. We specify the covariates of our model using \texttt{formula} and \texttt{phi.formula} as before, except we no longer include the response term because we are testing multiple taxa. We also specify which covariates we want to test for by removing them in the \texttt{formula\_null} and \texttt{phi.formula\_null} arguments. 

The difference between the formulas and the null version of the formulas will be the variables that are tested. In this case, as when we examined the single taxon, we will be testing the coefficients of \texttt{DayAmdmt} for both the expected relative abundance and the overdispersion.

We set \texttt{cutoff} to be our controlled false discovery rate.

In this example, we also set \texttt{inits} argument. This is not necessary, but it will speed up our computation because the algorithm does not need to identify initializations for the parameters for each taxon.

```{r}
set.seed(1)
fullAnalysis <- differentialTest(formula = ~ DayAmdmt,
                                 phi.formula = ~ DayAmdmt,
                                 formula_null = ~ 1,
                                 phi.formula_null = ~ 1,
                                 data = subsoil,
                                 cutoff = 0.05,
                                 inits = rbind(rep(.1, 4)))
```

We can examine a subset of the p-values of our tests using:

```{r}
fullAnalysis$p[1:5,]
```

where \texttt{DA} is the p-value associated with the test for differential abundance, \texttt{DV} is the p-value associated with the test for differential variance, and \texttt{Error} is a flag to let us know if the test wasn't able to complete for that OTU so that we may investigate further.

We can examine a subset of the p-values after controlling for the false discovery rate using:

```{r}
fullAnalysis$p_fdr[1:5,]
```

where the columns are defined similarly as before, but the values are now adjusted to control the false discovery rate at 0.05.

We can see a list of differentially-abundant taxa using: 

```{r}
fullAnalysis$DA
```

In this case, we identified 21 taxa that are differentially-abundant across \texttt{DayAmdmt} (out of the 100 taxa tested).


We can see a list of differentially-variable taxa using:

```{r}
fullAnalysis$DV
```

In this case, we identified 4 taxa that are differentially-variable across \texttt{DayAmdmt} (out of the 100 taxa tested).

Finally, we can see a list of any taxa that were not able to be compiled using:

```{r}
fullAnalysis$error
```

In this case, the list is empty so we were able to perform the test for all 100 taxa. If this list contained taxa, it would be worthwhile to investigate them individually to see what went wrong. For example, it may be that the model is overparameterized because there aren't enough observations, or it may just be that the initializations were invalid for that taxa and it needs to be re-evaluated with new initializations.

Note: The function \texttt{differentialTest} is currently in beta. If you notice an issues, please let me know! It will be completed soon.

